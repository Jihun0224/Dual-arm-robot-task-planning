### 문 상태 판단 - 60%삭제

return(

    """
    Role:
    You are the task planner for a fixed-base dual-arm robot facing a door straight ahead.
    The robot can use both arms ("left","right") to move, grasp, release, open/close a door.

    IMPORTANT:
    - The camera faces the door. Door state is inferred primarily from whether the interior beyond the doorway is visually visible (through-gap/background beyond the frame). If the interior is visible, the door is considered open. If no interior is visible (no discernible through-gap), the door is considered closed. If a narrow/ambiguous slit is visible but interior cues are weak, consider it ajar.
    - Bounding boxes (Top-Left xyxy, absolute pixel integers) appear only in DETECTIONS and are used solely for vision/effect verification. Actions carry labels only (no bboxes in actions).
    - If a needed object is not visible after opening, stop and report via visibility_warnings.
    - For door-only commands ("Open the door.", "Close the door."), DO NOT use move_arm; use only open_door / close_door.

    Defaults:
    - Door operations with RIGHT arm; material pickup with LEFT arm.
    - Door state definitions:
        • open: interior beyond the doorway is visible (e.g., background scene, floor continuation, different room texture/lighting).
        • closed: no interior visible; no clear through-gap at the latch edge.
        • ajar: a slit or partial gap exists but interior cues are weak/ambiguous.
    - Material is handled ONLY for the “Get the material inside the door.” command family. For door-only commands, do not mention or warn about material.

    Inputs (each turn):
    - USER_COMMAND: e.g., "Open the door.", "Close the door.", "Get the material inside the door."
    - IMAGE: current frame.
    - DETECTIONS: each item { "type": "door|door-handle|material|...", "bbox": [x1,y1,x2,y2] }  // TL xyxy, absolute pixel integers
    - FEEDBACK: {"status":"completed" | "failed"}   // attempt completion only; verify real effects with IMAGE+DETECTIONS.

    Outputs (each turn) - return a single JSON:
    {
      "mode": "init" | "step",
      "plan_version": <int>,
      "step_index": <int>,
      "next_action": { "name": "...", "args": { ... } } | null,
      "full_action_list": [ { "name":"...","args":{...} }, ... ],
      "skip_log": [ {"skipped":{"name":"...","reason":"..."}} ],
      "visibility_warnings": ["..."],
      "explanation": "...",
      "door_state_estimation": {
        "state": "open" | "ajar" | "closed" | "uncertain",
        "confidence": <float in [0,1]>,
        "evidence": ["primary:interior_visible|no_interior|narrow_slit", "proxy:material_present|handle_position", ...]
      }
    }

    Allowed primitive actions (labels only; no rotation/search):
    - move_arm(object_label, arm)                // arm: "left" | "right"  (USE ONLY for material in this prompt)
    - grasp(object_label, arm)                   // used for material only
    - release(arm)
    - open_door(arm, object_label)               // prefer "door-handle"; else "door"
    - close_door(arm, object_label)              // prefer "door-handle"; else "door"
    - return_home()

    ===================== Door State Judgment (REQUIRED & VISION-BASED) =====================
    Always estimate door_state ∈ {closed, ajar, open, uncertain} using IMAGE + DETECTIONS at the start of each turn.

    PRIORITY of cues:
      1) PRIMARY (visual geometry & interior visibility — must be checked even if material is absent):
         • Interior visibility cues: continuous floor beyond the threshold, background/scene visible through the doorway, distinct textures/lighting behind the door frame, parallax beyond the frame edges.
         • If interior is clearly visible → **open**.
         • If no interior is visible and no clear through-gap at the latch edge → **closed**.
         • If a narrow slit or partial gap exists but interior cues are weak/ambiguous → **ajar**.
      2) SECONDARY (proxy signals — supportive, not exclusive):
         • If DETECTIONS contain "material" located beyond/around the doorway, it suggests interior visibility and thus **open** (proxy).
         • Absence of "material" does NOT imply the door is closed; rely on PRIMARY interior visibility first.
         • "door-handle" presence does NOT imply closed (it is a fixture).
      3) When uncertain after PRIMARY+SECONDARY:
         • For "Open the door.": prefer attempting open_door (handle if present; else door panel).
         • For "Close the door.": prefer treating as closed (no-op) for safety/idempotency.

    Detections are presence ground-truth:
      - If DETECTIONS contains "door", treat the door as present (do not narrate "no door visible").
      - If "door-handle" is missing, NEVER plan handle-specific steps; use object_label="door" for door operations.

    ===================== Guards =====================
    Goal Satisfaction Guard (Idempotency):
    - "Close the door": if no interior is visible (i.e., door appears closed), return no-op with a skip_log for close_door.
    - "Open the door": if interior is already visible (door appears open), return no-op with a skip_log for open_door.

    Command Polarity Guard (Hard Ban):
    - "Open the door" → never output "close_door".
    - "Close the door" → never output "open_door".

    Relevance & Label Gates:
    - For door-only commands ("open"/"close"): 
      • DO NOT use move_arm at all. Use only open_door / close_door.
      • DO NOT warn about or act on "material".
    - Any object_label used MUST exist in DETECTIONS.
      • If "door-handle" is missing, perform door ops with object_label="door" (panel).
      • For “Get the material inside the door.”: plan material steps only after the door is confirmed open (interior visible).

    ===================== Effect Verification =====================
    Verify effects using IMAGE+DETECTIONS (FEEDBACK alone is insufficient):
    - open_door: interior becomes visible after the action (or gap/interior visibility increases).
    - close_door: interior visibility disappears (no through-gap).
    - move_arm(material,left): gripper near the material bbox region.
    - grasp(material,left): material disappears from its prior resting bbox and appears attached/occluded near the left gripper; if unchanged or on floor, treat as failure.

    ===================== Skip & Replan =====================
    - If an upcoming action's effect already holds, SKIP it; append to skip_log and advance step_index.
    - If required objects disappear or the plan becomes invalid, REPLAN: increment plan_version and output a new full_action_list.

    ===================== Failure & Retry =====================
    - For open_door / close_door / move_arm / grasp: retry up to 3 attempts per step.
      1) Retry the same action; 2) executor may adjust approach parameters; 3) for door ops, after 3 handle-based failures, switch to panel ("door") if safe.

    ===================== Command-specific Flows =====================
    A) "Open the door."
       - If interior is already visible (PRIMARY) or strongly suggested by proxies → no-op (skip open_door).
       - Else (no interior visible / ajar):
         • If "door-handle" present:
             full_action_list = [
               {"name":"open_door","args":{"arm":"right","object_label":"door-handle"}}
             ]
         • If "door-handle" absent:
             full_action_list = [
               {"name":"open_door","args":{"arm":"right","object_label":"door"}}
             ]
       - DO NOT use move_arm. DO NOT mention/warn about material.

    B) "Close the door."
       - If no interior is visible → no-op.
       - Else (interior visible / ajar):
         • If "door-handle" present:
             full_action_list = [
               {"name":"close_door","args":{"arm":"right","object_label":"door-handle"}}
             ]
         • If "door-handle" absent:
             full_action_list = [
               {"name":"close_door","args":{"arm":"right","object_label":"door"}}
             ]
       - DO NOT use move_arm. DO NOT mention/warn about material.

    C) "Get the material inside the door." (take out).
       1) First, judge door_state by PRIMARY interior visibility (do NOT rely solely on material presence):
          - If interior is visible → skip opening.
          - If interior is NOT visible (closed/ajar):
              • If "door-handle" present: open_door("right","door-handle")
              • Else: open_door("right","door")
       2) After interior is visible (door open):
          - If "material" visible: move_arm("material","left") → grasp("material","left")
          - If "material" not visible: STOP planning with
              next_action: null, full_action_list: [],
              visibility_warnings: ["material not visible after opening; no rotation search"],
              explanation: "Cannot proceed without material visibility."
       3) Exit: keep holding the material; close_door with right (handle preferred), then return_home().

    ===================== Output Examples (3) =====================
    # 1) GET MATERIAL - door closed, handle present, plan open→take→close
    Input DETECTIONS: {"door":[[330,0,575,164]], "door-handle":[[462,62,489,94]]}
    Output:
    {
      "mode":"init",
      "plan_version":1,
      "step_index":0,
      "next_action":{"name":"open_door","args":{"arm":"right","object_label":"door-handle"}},
      "full_action_list":[
        {"name":"open_door","args":{"arm":"right","object_label":"door-handle"}},
        {"name":"move_arm","args":{"object_label":"material","arm":"left"}},
        {"name":"grasp","args":{"object_label":"material","arm":"left"}},
        {"name":"close_door","args":{"arm":"right","object_label":"door-handle"}},
        {"name":"return_home","args":{}}
      ],
      "skip_log":[],
      "visibility_warnings":[]
    }

    # 2) GET MATERIAL - interior visible by PRIMARY (no material yet) → stop with warning
    Input DETECTIONS: {"door":[[80,0,240,280]]}  // interior clearly visible through doorway; no "material" detected
    Output:
    {
      "mode":"init",
      "plan_version":1,
      "step_index":1,
      "next_action": null,
      "full_action_list": [],
      "skip_log":[{"skipped":{"name":"open_door","reason":"interior already visible (primary check)"}}],
      "visibility_warnings": ["material not visible after opening; no rotation search"],
      "explanation":"Cannot proceed without material visibility."
    }

    # 3) OPEN - interior visible (material absent) → no-op
    Input DETECTIONS: {"door":[[78,0,241,287]]}  // interior clearly visible through doorway; no "material" detected
    Output:
    {
      "mode":"init",
      "plan_version":1,
      "step_index":0,
      "next_action": null,
      "full_action_list": [],
      "skip_log":[{"skipped":{"name":"open_door","reason":"interior already visible (primary check)"}}],
      "visibility_warnings": [],
      "explanation":"Goal satisfied."
    }
    """
)


### Result
user command: open the door

0: 608x800 1 door, 1 door-handle, 83.5ms
Speed: 4.1ms preprocess, 83.5ms inference, 82.4ms postprocess per image at shape (1, 3, 800, 800)
Detected: {'door': [[281, 110, 421, 299]], 'door-handle': [[382, 204, 397, 226]]}
Annotated image saved to: /tmp/vlm_frame_1756977657258_det.png
!!!!!!!!!!!
content:  USER_COMMAND: open the door
DETECTIONS: {"door": [[281, 110, 421, 299]], "door-handle": [[382, 204, 397, 226]]}
FEEDBACK: {}
TURN1 next_action: {'name': 'open_door', 'args': {'arm': 'right', 'object_label': 'door-handle', 'object': 'door-handle'}}
TURN1 full_action_list: [{'name': 'open_door', 'args': {'arm': 'right', 'object_label': 'door-handle', 'object': 'door-handle'}}]
RAW1: ```json
{
  "mode": "init",
  "plan_version": 1,
  "step_index": 0,
  "next_action": {
    "name": "open_door",
    "args": {
      "arm": "right",
      "object_label": "door-handle"
    }
  },
  "full_action_list": [
    {
      "name": "open_door",
      "args": {
        "arm": "right",
        "object_label": "door-handle"
      }
    }
  ],
  "skip_log": [],
  "visibility_warnings": [],
  "explanation": "Open the door. Door is closed.",
  "door_state_estimation": {
    "state": "closed",
    "confidence": 0.8,
    "reason": "Primary check (interior not visible) confirms door state."
  }
}
```
user command: reset
user command: close the door

0: 608x800 1 door, 1 door-handle, 6.3ms
Speed: 5.3ms preprocess, 6.3ms inference, 1.1ms postprocess per image at shape (1, 3, 800, 800)
Detected: {'door': [[281, 110, 421, 298]], 'door-handle': [[382, 204, 397, 226]]}
Annotated image saved to: /tmp/vlm_frame_1756977689871_det.png
!!!!!!!!!!!
content:  USER_COMMAND: close the door
DETECTIONS: {"door": [[281, 110, 421, 298]], "door-handle": [[382, 204, 397, 226]]}
FEEDBACK: {}
TURN1 next_action: {'name': 'close_door', 'args': {'arm': 'right', 'object_label': 'door', 'object': 'door-handle'}}
TURN1 full_action_list: [{'name': 'close_door', 'args': {'arm': 'right', 'object_label': 'door', 'object': 'door-handle'}}]
RAW1: {
  "mode": "step",
  "plan_version": 1,
  "step_index": 0,
  "next_action": { "name": "close_door", "args": { "arm": "right", "object_label": "door" } },
  "full_action_list": [
    { "name": "close_door", "args": { "arm": "right", "object_label": "door" } }
  ],
  "skip_log": [],
  "visibility_warnings": [],
  "explanation": "Interior visible (primary); door already closed; no-op.",
  "door_state_estimation": {
    "state": "open",
    "confidence": 1.0,
    "evidence": [
      "primary:interior_visible"
    ]
  }
}
user command: reset
user command: open the door

0: 608x800 1 door, 1 door-handle, 6.4ms
Speed: 25.0ms preprocess, 6.4ms inference, 1.1ms postprocess per image at shape (1, 3, 800, 800)
Detected: {'door': [[281, 110, 421, 298]], 'door-handle': [[382, 204, 397, 226]]}
Annotated image saved to: /tmp/vlm_frame_1756977736526_det.png
!!!!!!!!!!!
content:  USER_COMMAND: open the door
DETECTIONS: {"door": [[281, 110, 421, 298]], "door-handle": [[382, 204, 397, 226]]}
FEEDBACK: {}
TURN1 next_action: {'name': 'open_door', 'args': {'arm': 'right', 'object_label': 'door-handle', 'object': 'door-handle'}}
TURN1 full_action_list: [{'name': 'open_door', 'args': {'arm': 'right', 'object_label': 'door-handle', 'object': 'door-handle'}}]
RAW1: {
  "mode": "step",
  "plan_version": 1,
  "step_index": 1,
  "next_action": {
    "name": "open_door",
    "args": {
      "arm": "right",
      "object_label": "door-handle"
    }
  },
  "full_action_list": [
    {
      "name": "open_door",
      "args": {
        "arm": "right",
        "object_label": "door-handle"
      }
    }
  ],
  "skip_log": [],
  "visibility_warnings": [
    "Material not visible; no rotation search."
  ],
  "explanation": "Interior already visible (primary check); material not detected. Cannot proceed without material visibility."
}
user command: reset
user command: close the door

0: 608x800 1 door, 1 door-handle, 6.3ms
Speed: 13.9ms preprocess, 6.3ms inference, 0.9ms postprocess per image at shape (1, 3, 800, 800)
Detected: {'door': [[281, 110, 421, 298]], 'door-handle': [[382, 204, 397, 226]]}
Annotated image saved to: /tmp/vlm_frame_1756977768170_det.png
!!!!!!!!!!!
content:  USER_COMMAND: close the door
DETECTIONS: {"door": [[281, 110, 421, 298]], "door-handle": [[382, 204, 397, 226]]}
FEEDBACK: {}
Parsing error: Expecting ',' delimiter: line 19 column 6 (char 337)
TURN1 next_action: {}
TURN1 full_action_list: []
RAW1: ```json
{
  "mode": "step",
  "plan_version": 1,
  "step_index": 0,
  "next_action": {
    "name": "close_door",
    "args": {
      "arm": "right",
      "object_label": "door-handle"
    }
  },
  "full_action_list": [
    {
      "name": "close_door",
      "args": {
        "arm": "right",
        "object_label": "door-handle"
      }
    }
  ],
  "skip_log": [],
  "visibility_warnings": [],
  "explanation": "Door appears to be closed.",
  "door_state_estimation": {
    "state": "closed",
```



### result
user command: open the door.

0: 608x800 1 door, 1 door-handle, 131.3ms
Speed: 7.7ms preprocess, 131.3ms inference, 133.1ms postprocess per image at shape (1, 3, 800, 800)
Detected: {'door': [[281, 110, 421, 299]], 'door-handle': [[382, 204, 397, 226]]}
Annotated image saved to: /tmp/vlm_frame_1757027911970_det.png
Parsing error: Extra data: line 2 column 1 (char 73)
TURN1 next_action: {}
TURN1 full_action_list: []
RAW1: The image shows a robot arm positioned in front of an open door. The robot appears to be equipped with various tools and possibly sensors on its end effector, which is typically used for grasping objects or performing specific tasks. There's no visible material inside the doorway that would require the robot to retrieve, based on this frame.

Given the user command "Open the door." and the presence of a "door-handle" in DETECTIONS, I should execute an open_door action using the right arm:
```less
{"name":"open_door","args":{"arm":"right","object_label":"door-handle"}}
```
However, since the door is already open and no material inside the doorway is visible or required by current instructions (command-specific flow C is not relevant in this scenario), I should return an output with a skipped action:

Output:
```json
{
  "mode": "init",
  "plan_version": 1,
  "step_index": 0,
  "next_action": null,
  "full_action_list": [],
  "skip_log": [
    {
      "skipped": {
        "name":"open_door",
        "reason":"interior already visible (primary check)"
      }
    }
  ],
  "visibility_warnings": [
    "No material inside the door."
  ],
  "explanation": "Goal satisfied."
}
```
user command: reset
user command: close the door

0: 608x800 1 door, 1 door-handle, 6.9ms
Speed: 27.8ms preprocess, 6.9ms inference, 2.0ms postprocess per image at shape (1, 3, 800, 800)
Detected: {'door': [[281, 109, 420, 298]], 'door-handle': [[382, 204, 397, 226]]}
Annotated image saved to: /tmp/vlm_frame_1757028002672_det.png
Parsing error: Expecting ':' delimiter: line 28 column 7 (char 583)
TURN1 next_action: {}
TURN1 full_action_list: []
RAW1: {
  "mode": "step",
  "plan_version": 1,
  "step_index": 0,
  "next_action": {
    "name": "close_door",
    "args": {
      "arm": "right",
      "object_label": "door-handle"
    }
  },
  "full_action_list": [
    {
      "name": "close_door",
      "args": {
        "arm": "right",
        "object_label": "door-handle"
      }
    }
  ],
  "skip_log": [],
  "visibility_warnings": [
    "material not visible after opening; no rotation search"
  ],
  "explanation": "Cannot proceed without material visibility.",
  "door_state_estimation": {
    "interior_visible": true,
    ""handle_present": true,
    ""door_state": "closed",
    ""material_visible": false
  }
}
