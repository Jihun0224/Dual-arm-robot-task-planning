# 0905 기존 prompt에 예시 추가

return(
"""
Role:
You are the task planner for a fixed-base dual-arm robot facing a door straight ahead.
The robot can use both arms ("left","right") to move, grasp, release, open/close a door, and take out material.

IMPORTANT:
- The camera faces the door. Door state is inferred from visual cues:
  • open: interior clearly visible (background/floor continuation/scene beyond doorframe).
  • closed: no interior visible, no gap.
  • ajar: narrow slit or ambiguous interior cues.
  • uncertain: cannot classify reliably.
- Bounding boxes (Top-Left xyxy, absolute pixel integers) appear only in DETECTIONS and are used solely for verification. Actions carry labels only (no bboxes in actions).
- For door-only commands, never mention or act on material.

Inputs (each turn):
- USER_COMMAND: e.g., "Open the door.", "Close the door.", "Get the material inside the door."
- IMAGE: current frame.
- DETECTIONS: each item { "type": "door|door-handle|material|...", "bbox": [x1,y1,x2,y2] }
- FEEDBACK: {"status":"completed" | "failed"}

Outputs (each turn) — return exactly ONE JSON object:
{
  "mode": "init" | "step",
  "plan_version": <int>,
  "step_index": <int>,
  "next_action": { "name":"...", "args":{...} } | null,
  "full_action_list": [ { "name":"...","args":{...} }, ... ],
  "skip_log": [ {"skipped":{"name":"...","reason":"..."}} ],
  "visibility_warnings": [],
  "explanation": "...",
  "door_state_estimation": {
    "state": "open" | "ajar" | "closed" | "uncertain",
    "confidence": <float 0..1>,
    "evidence": ["primary:...","proxy:..."]
  },
  "observations": {
    "handle_present": true|false,
    "material_visible": true|false|"uncertain"
  },
  "gate_evaluations": [
    {"gate":"need_open_door","result":true|false|"uncertain","reason":"..."},
    {"gate":"material_visible_after_open","result":true|false|"uncertain","reason":"..."}
  ],
  "goal_status": {
    "status": "in_progress" | "satisfied" | "blocked",
    "reason_code": "OK | ALREADY_OPEN | ALREADY_CLOSED | MATERIAL_NOT_VISIBLE_AFTER_OPEN | UNCERTAIN_PERCEPTION",
    "message": "..."
  },
  "stop_signal": {
    "should_stop": true|false,
    "reason_code": "...",
    "notify": true|false,
    "message": "..."
  },
  "arm_policy": {
    "material_arm": "right"
  }
}

===================== Guards & Rules =====================

[JSON RULES]
- Always output one minified JSON object. No prose, no code fences, no comments.
- Allowed top-level keys: exactly as defined above. No extras.
- Action names allowed: ["move_arm","grasp","release","open_door","close_door","return_home"].
- Args schema:
  • open_door/close_door: {"arm":"left|right","object_label":"door|door-handle"}
  • move_arm/grasp: {"object_label":"material","arm":"left|right"}
  • release: {"arm":"left|right"}
  • return_home: {}
- object_label must exist in DETECTIONS. If "door-handle" missing, use "door".

[DOOR STATE GUARD]
- "Open the door.":
  • If state=open → next_action=null, full_action_list=[], skip_log=[{"skipped":{"name":"open_door","reason":"already open"}}], goal_status.satisfied.
  • Else → plan open_door (handle if present else door).
- "Close the door.":
  • If state=closed → next_action=null, full_action_list=[], skip_log=[{"skipped":{"name":"close_door","reason":"already close"}}], goal_status.satisfied.
  • Else → plan close_door.
- "Get the material inside the door.":
  1) If door closed/ajar → first open_door.
  2) After interior visible:
     • If material visible → move_arm(material,right) → grasp(material,right) → close_door(right,handle if present else door) → return_home.
     • If material not visible → stop_signal.should_stop=true, goal_status.blocked.

[full_action_list & skip_log]
- full_action_list must include only the remaining executable actions (skipped actions are removed).
- Any skipped action must be logged in skip_log with standardized reason ("already open","already closed").

[visibility_warnings]
- For door-only commands: always [].
- For material commands: warn only if needed (e.g., "material not visible after opening").

[goal_status]
- "in_progress": currently executing valid plan.
- "satisfied": goal already met without action.
- "blocked": cannot proceed (e.g., material not visible).

[stop_signal]
- Present only if blocked. Use standardized reason_code.

[Format]
- Output minified JSON, float confidence with one decimal place.
- Key order recommended: mode,plan_version,step_index,next_action,full_action_list,skip_log,visibility_warnings,explanation,door_state_estimation,observations,gate_evaluations,goal_status,stop_signal,arm_policy.

===================== Examples =====================

# 1) Door open but command = "Open the door." → no-op
{
  "mode": "init",
  "plan_version": 1,
  "step_index": 0,
  "next_action": null,
  "full_action_list": [],
  "skip_log": [
    {
      "skipped": {
        "name": "open_door",
        "reason": "already open"
      }
    }
  ],
  "visibility_warnings": [],
  "explanation": "Door already open; goal satisfied.",
  "door_state_estimation": {
    "state": "open",
    "confidence": 0.9,
    "evidence": [
      "primary:interior_visible"
    ]
  },
  "observations": {
    "handle_present": true,
    "material_visible": "uncertain"
  },
  "gate_evaluations": [
    {
      "gate": "need_open_door",
      "result": false,
      "reason": "already open"
    }
  ],
  "goal_status": {
    "status": "satisfied",
    "reason_code": "ALREADY_OPEN",
    "message": "door already open"
  },
  "arm_policy": {
    "material_arm": "right"
  }
}

# 2) Door closed and command = "Open the door." → open_door plan
{
  "mode": "init",
  "plan_version": 1,
  "step_index": 0,
  "next_action": {
    "name": "open_door",
    "args": {
      "arm": "right",
      "object_label": "door-handle"
    }
  },
  "full_action_list": [
    {
      "name": "open_door",
      "args": {
        "arm": "right",
        "object_label": "door-handle"
      }
    }
  ],
  "skip_log": [],
  "visibility_warnings": [],
  "explanation": "Door closed; opening.",
  "door_state_estimation": {
    "state": "closed",
    "confidence": 0.9,
    "evidence": [
      "primary:no_interior"
    ]
  },
  "observations": {
    "handle_present": true,
    "material_visible": "uncertain"
  },
  "gate_evaluations": [
    {
      "gate": "need_open_door",
      "result": true,
      "reason": "door_state=closed"
    }
  ],
  "goal_status": {
    "status": "in_progress",
    "reason_code": "OK",
    "message": "execute open_door"
  },
  "arm_policy": {
    "material_arm": "right"
  }
}
# 3) Door closed and command = "Close the door." → no-op
{
  "mode": "init",
  "plan_version": 1,
  "step_index": 0,
  "next_action": null,
  "full_action_list": [],
  "skip_log": [
    {
      "skipped": {
        "name": "close_door",
        "reason": "already closed"
      }
    }
  ],
  "visibility_warnings": [],
  "explanation": "Door already closed; goal satisfied.",
  "door_state_estimation": {
    "state": "closed",
    "confidence": 0.9,
    "evidence": [
      "primary:no_interior"
    ]
  },
  "observations": {
    "handle_present": true,
    "material_visible": "uncertain"
  },
  "gate_evaluations": [],
  "goal_status": {
    "status": "satisfied",
    "reason_code": "ALREADY_CLOSED",
    "message": "door already closed"
  },
  "arm_policy": {
    "material_arm": "right"
  }
}
# 4) Door open and command = "Close the door." → close_door plan
{
  "mode": "init",
  "plan_version": 1,
  "step_index": 0,
  "next_action": {
    "name": "close_door",
    "args": {
      "arm": "right",
      "object_label": "door-handle"
    }
  },
  "full_action_list": [
    {
      "name": "close_door",
      "args": {
        "arm": "right",
        "object_label": "door-handle"
      }
    }
  ],
  "skip_log": [],
  "visibility_warnings": [],
  "explanation": "Door open; closing.",
  "door_state_estimation": {
    "state": "open",
    "confidence": 0.9,
    "evidence": [
      "primary:interior_visible"
    ]
  },
  "observations": {
    "handle_present": true,
    "material_visible": "uncertain"
  },
  "gate_evaluations": [],
  "goal_status": {
    "status": "in_progress",
    "reason_code": "OK",
    "message": "execute close_door"
  },
  "arm_policy": {
    "material_arm": "right"
  }
}
# 5) Door open and command = "Get the material inside the door." → skip open_door, then grasp & close
{
  "mode": "init",
  "plan_version": 1,
  "step_index": 0,
  "next_action": {
    "name": "move_arm",
    "args": {
      "object_label": "material",
      "arm": "right"
    }
  },
  "full_action_list": [
    {
      "name": "move_arm",
      "args": {
        "object_label": "material",
        "arm": "right"
      }
    },
    {
      "name": "grasp",
      "args": {
        "object_label": "material",
        "arm": "right"
      }
    },
    {
      "name": "close_door",
      "args": {
        "arm": "right",
        "object_label": "door-handle"
      }
    },
    {
      "name": "return_home",
      "args": {}
    }
  ],
  "skip_log": [
    {
      "skipped": {
        "name": "open_door",
        "reason": "already open"
      }
    }
  ],
  "visibility_warnings": [],
  "explanation": "Door open; approach and grasp material, then close door.",
  "door_state_estimation": {
    "state": "open",
    "confidence": 0.9,
    "evidence": [
      "primary:interior_visible"
    ]
  },
  "observations": {
    "handle_present": false,
    "material_visible": true
  },
  "gate_evaluations": [
    {
      "gate": "need_open_door",
      "result": false,
      "reason": "already open"
    },
    {
      "gate": "material_visible_after_open",
      "result": true,
      "reason": "material detected"
    }
  ],
  "goal_status": {
    "status": "in_progress",
    "reason_code": "OK",
    "message": "approach material"
  },
  "arm_policy": {
    "material_arm": "right"
  }
}
# 6) Door closed and command = "Get the material inside the door." → start from open_door then grasp & close
{
  "mode": "init",
  "plan_version": 1,
  "step_index": 0,
  "next_action": {
    "name": "open_door",
    "args": {
      "arm": "right",
      "object_label": "door-handle"
    }
  },
  "full_action_list": [
    {
      "name": "open_door",
      "args": {
        "arm": "right",
        "object_label": "door-handle"
      }
    },
    {
      "name": "move_arm",
      "args": {
        "object_label": "material",
        "arm": "right"
      }
    },
    {
      "name": "grasp",
      "args": {
        "object_label": "material",
        "arm": "right"
      }
    },
    {
      "name": "close_door",
      "args": {
        "arm": "right",
        "object_label": "door-handle"
      }
    },
    {
      "name": "return_home",
      "args": {}
    }
  ],
  "skip_log": [],
  "visibility_warnings": [],
  "explanation": "Door closed; open first, then grasp material and close.",
  "door_state_estimation": {
    "state": "closed",
    "confidence": 0.9,
    "evidence": [
      "primary:no_interior"
    ]
  },
  "observations": {
    "handle_present": true,
    "material_visible": "uncertain"
  },
  "gate_evaluations": [
    {
      "gate": "need_open_door",
      "result": true,
      "reason": "door_state=closed"
    },
    {
      "gate": "material_visible_after_open",
      "result": "uncertain",
      "reason": "material to be checked after opening"
    }
  ],
  "goal_status": {
    "status": "in_progress",
    "reason_code": "OK",
    "message": "execute open_door"
  },
  "arm_policy": {
    "material_arm": "right"
  }
}
"""
)


# qwen2.5vl:7b 결과
user command: open the door.

0: 608x800 1 door, 1 door-handle, 76.8ms
Speed: 4.1ms preprocess, 76.8ms inference, 82.3ms postprocess per image at shape (1, 3, 800, 800)
Detected: {'door': [[225, 171, 400, 367]], 'door-handle': [[358, 267, 376, 290]]}
Annotated image saved to: /tmp/vlm_frame_1757036676731_det.png
TURN1 next_action: {'name': 'open_door', 'args': {'arm': 'right', 'object_label': 'door-handle', 'object': 'door-handle'}}
TURN1 full_action_list: [{'name': 'open_door', 'args': {'arm': 'right', 'object_label': 'door-handle', 'object': 'door-handle'}}]
RAW1: {
  "mode": "init",
  "plan_version": 1,
  "step_index": 0,
  "next_action": {
    "name": "open_door",
    "args": {
      "arm": "right",
      "object_label": "door-handle"
    }
  },
  "full_action_list": [
    {
      "name": "open_door",
      "args": {
        "arm": "right",
        "object_label": "door-handle"
      }
    }
  ],
  "skip_log": [],
  "visibility_warnings": [],
  "explanation": "Door closed; opening.",
  "door_state_estimation": {
    "state": "closed",
    "confidence": 0.9,
    "evidence": [
      "primary:no_interior"
    ]
  },
  "observations": {
    "handle_present": true,
    "material_visible": "uncertain"
  },
  "gate_evaluations": [
    {
      "gate": "need_open_door",
      "result": true,
      "reason": "door_state=closed"
    }
  ],
  "goal_status": {
    "status": "in_progress",
    "reason_code": "OK",
    "message": "execute open_door"
  },
  "arm_policy": {
    "material_arm": "right"
  }
}
user command: reset
user command: close the door.

0: 608x800 1 door, 1 door-handle, 6.5ms
Speed: 7.0ms preprocess, 6.5ms inference, 1.4ms postprocess per image at shape (1, 3, 800, 800)
Detected: {'door': [[225, 171, 400, 367]], 'door-handle': [[358, 267, 376, 290]]}
Annotated image saved to: /tmp/vlm_frame_1757036698319_det.png
TURN1 next_action: {'name': 'close_door', 'args': {'arm': 'right', 'object_label': 'door-handle', 'object': 'door-handle'}}
TURN1 full_action_list: [{'name': 'close_door', 'args': {'arm': 'right', 'object_label': 'door-handle', 'object': 'door-handle'}}]
RAW1: {
  "mode": "step",
  "plan_version": 1,
  "step_index": 1,
  "next_action": {
    "name": "close_door",
    "args": {
      "arm": "right",
      "object_label": "door-handle"
    }
  },
  "full_action_list": [
    {
      "name": "close_door",
      "args": {
        "arm": "right",
        "object_label": "door-handle"
      }
    }
  ],
  "skip_log": [],
  "visibility_warnings": [],
  "explanation": "Closing the door.",
  "door_state_estimation": {
    "state": "closed",
    "confidence": 0.9,
    "evidence": [
      "primary:no_interior"
    ]
  },
  "observations": {
    "handle_present": true,
    "material_visible": "uncertain"
  },
  "gate_evaluations": [
    {
      "gate": "need_open_door",
      "result": false,
      "reason": "door_state=closed"
    },
    {
      "gate": "material_visible_after_open",
      "result": "uncertain",
      "reason": "material to be checked after opening"
    }
  ],
  "goal_status": {
    "status": "in_progress",
    "reason_code": "OK",
    "message": "execute close_door"
  },
  "arm_policy": {
    "material_arm": "right"
  }
}
user command: reset
user command: get the material unside the door

0: 608x800 1 door, 1 door-handle, 6.4ms
Speed: 20.8ms preprocess, 6.4ms inference, 1.7ms postprocess per image at shape (1, 3, 800, 800)
Detected: {'door': [[225, 170, 400, 367]], 'door-handle': [[359, 267, 376, 290]]}
Annotated image saved to: /tmp/vlm_frame_1757036818147_det.png
TURN1 next_action: {'name': 'open_door', 'args': {'arm': 'right', 'object_label': 'door-handle', 'object': 'door-handle'}}
TURN1 full_action_list: [{'name': 'open_door', 'args': {'arm': 'right', 'object_label': 'door-handle', 'object': 'door-handle'}}]
RAW1: {
  "mode": "init",
  "plan_version": 1,
  "step_index": 0,
  "next_action": {
    "name": "open_door",
    "args": {
      "arm": "right",
      "object_label": "door-handle"
    }
  },
  "full_action_list": [
    {
      "name": "open_door",
      "args": {
        "arm": "right",
        "object_label": "door-handle"
      }
    }
  ],
  "skip_log": [],
  "visibility_warnings": [],
  "explanation": "Door closed; opening.",
  "door_state_estimation": {
    "state": "closed",
    "confidence": 0.9,
    "evidence": [
      "primary:no_interior"
    ]
  },
  "observations": {
    "handle_present": true,
    "material_visible": "uncertain"
  },
  "gate_evaluations": [
    {
      "gate": "need_open_door",
      "result": true,
      "reason": "door_state=closed"
    },
    {
      "gate": "material_visible_after_open",
      "result": "uncertain",
      "reason": "material to be checked after opening"
    }
  ],
  "goal_status": {
    "status": "in_progress",
    "reason_code": "OK",
    "message": "execute open_door"
  },
  "arm_policy": {
    "material_arm": "right"
  }
}
user command: get the material unside the door

0: 608x800 1 door, 1 material, 6.4ms
Speed: 16.7ms preprocess, 6.4ms inference, 1.9ms postprocess per image at shape (1, 3, 800, 800)
Detected: {'door': [[114, 163, 264, 463]], 'material': [[311, 307, 322, 320]]}
Annotated image saved to: /tmp/vlm_frame_1757036867772_det.png
TURN2 next_action: {'name': 'open_door', 'args': {'arm': 'right', 'object_label': 'door-handle'}}
TURN2 full_action_list: [{'name': 'open_door', 'args': {'arm': 'right', 'object_label': 'door-handle'}}, {'name': 'move_arm', 'args': {'object_label': 'material', 'arm': 'right'}}, {'name': 'grasp', 'args': {'object_label': 'material', 'arm': 'right'}}, {'name': 'close_door', 'args': {'arm': 'right', 'object_label': 'door-handle'}}, {'name': 'return_home', 'args': {}}]
RAW2: {
  "mode": "init",
  "plan_version": 1,
  "step_index": 0,
  "next_action": {
    "name": "open_door",
    "args": {
      "arm": "right",
      "object_label": "door-handle"
    }
  },
  "full_action_list": [
    {
      "name": "open_door",
      "args": {
        "arm": "right",
        "object_label": "door-handle"
      }
    },
    {
      "name": "move_arm",
      "args": {
        "object_label": "material",
        "arm": "right"
      }
    },
    {
      "name": "grasp",
      "args": {
        "object_label": "material",
        "arm": "right"
      }
    },
    {
      "name": "close_door",
      "args": {
        "arm": "right",
        "object_label": "door-handle"
      }
    },
    {
      "name": "return_home",
      "args": {}
    }
  ],
  "skip_log": [],
  "visibility_warnings": [],
  "explanation": "Door closed; open first, then grasp material and close.",
  "door_state_estimation": {
    "state": "closed",
    "confidence": 0.9,
    "evidence": [
      "primary:no_interior"
    ]
  },
  "observations": {
    "handle_present": true,
    "material_visible": true
  },
  "gate_evaluations": [
    {
      "gate": "need_open_door",
      "result": true,
      "reason": "door_state=closed"
    },
    {
      "gate": "material_visible_after_open",
      "result": true,
      "reason": "material detected"
    }
  ],
  "goal_status": {
    "status": "in_progress",
    "reason_code": "OK",
    "message": "execute open_door"
  },
  "arm_policy": {
    "material_arm": "right"
  }
}


## llava:34b-1.6v
user command: close the door

0: 608x800 1 door, 1 door-handle, 91.9ms
Speed: 4.9ms preprocess, 91.9ms inference, 85.7ms postprocess per image at shape (1, 3, 800, 800)
Detected: {'door': [[227, 171, 402, 365]], 'door-handle': [[360, 267, 377, 290]]}
Annotated image saved to: /tmp/vlm_frame_1757036337383_det.png
TURN1 next_action: {}
TURN1 full_action_list: []
RAW1: I'm sorry, but there isn't a door in the image you provided. It appears to be an indoor scene with a few people at desks and some equipment, including what looks like robotic arms. There is no visible door that can be closed as per your request. If you have another question or need assistance with something else, feel free to ask!
user command: open thed oor

0: 608x800 1 door, 1 door-handle, 6.4ms
Speed: 5.9ms preprocess, 6.4ms inference, 1.1ms postprocess per image at shape (1, 3, 800, 800)
Detected: {'door': [[227, 171, 402, 365]], 'door-handle': [[360, 267, 377, 290]]}
Annotated image saved to: /tmp/vlm_frame_1757036356951_det.png
TURN2 next_action: {}
TURN2 full_action_list: []
RAW2: ERROR: door is closed
EXPLANATION: The feedback indicates that the door is currently in a closed state. To proceed with opening the door, please ensure that the robot arm (if applicable) and any physical devices attached to it are in the correct position and clear of any obstacles. Once ready, you may issue a command to open the door by specifying the appropriate action and target location.

Please note that if the door is secured or requires manual intervention for opening, additional steps may be necessary. It would be helpful to provide specific details about the door's locking mechanism and its current state (e.g. locked with key, lever, or other means) so that appropriate measures can be taken to ensure safe and efficient operation of the robot in this scenario.
user command: reset
user command: open the door.

0: 608x800 1 door, 1 door-handle, 7.9ms
Speed: 5.9ms preprocess, 7.9ms inference, 2.2ms postprocess per image at shape (1, 3, 800, 800)
Detected: {'door': [[227, 171, 402, 366]], 'door-handle': [[360, 267, 377, 290]]}
Annotated image saved to: /tmp/vlm_frame_1757036391561_det.png
TURN1 next_action: {}
TURN1 full_action_list: []
RAW1: It appears there is a door handle in the image. However, there are no robots visible that can physically open doors, and the objects present do not seem to be capable of opening a door. The items look like robotic equipment or machinery parts, possibly for manufacturing or research purposes.
user command: reset
user command: open the door.

0: 608x800 1 door, 1 door-handle, 6.6ms
Speed: 5.2ms preprocess, 6.6ms inference, 0.9ms postprocess per image at shape (1, 3, 800, 800)
Detected: {'door': [[227, 171, 402, 366]], 'door-handle': [[360, 267, 377, 290]]}
Annotated image saved to: /tmp/vlm_frame_1757036407113_det.png
TURN1 next_action: {}
TURN1 full_action_list: []
RAW1: The image shows a room with several robotic arms positioned around the center. There is no visible door in this frame of the image; however, there are what appear to be computer monitors and a person sitting at one of them in the background. If you need assistance with something else or if there's another part of the photo I can assist with, please let me know!
user command: reset
user command: close the door.

0: 608x800 1 door, 1 door-handle, 6.4ms
Speed: 16.5ms preprocess, 6.4ms inference, 1.4ms postprocess per image at shape (1, 3, 800, 800)
Detected: {'door': [[225, 172, 399, 368]], 'door-handle': [[358, 267, 375, 290]]}
Annotated image saved to: /tmp/vlm_frame_1757036429697_det.png
TURN1 next_action: {}
TURN1 full_action_list: []
RAW1: I'm sorry, but I am unable to directly control or move objects in the real world. However, I can provide you with instructions on how to close a door based on what I see in this image. The door is located towards the top right of the image and it appears to be an ordinary interior door with a handle on its left side when viewed from the perspective shown in the photo.

To close the door, you would typically approach the door and grab the handle. Then, use one hand to pull or push the door depending on how the hinges are positioned. If there is no visible hinge in the image, it's likely that the door swings outwards, so you should push the door with your right hand (if you're right-handed). Once the door reaches its closed position, release it and it should latch shut.

If this were a command to be given to someone or something in the image, I would provide an instruction such as "Please close the door" assuming that there is a person nearby who can hear and interpret these instructions.
user command: reset
user command: get the material inside the door

0: 608x800 1 door, 1 door-handle, 10.2ms
Speed: 7.4ms preprocess, 10.2ms inference, 4.3ms postprocess per image at shape (1, 3, 800, 800)
Detected: {'door': [[225, 171, 400, 367]], 'door-handle': [[359, 267, 376, 290]]}
Annotated image saved to: /tmp/vlm_frame_1757036583699_det.png
TURN1 next_action: {}
TURN1 full_action_list: []
RAW1: The image shows a room with various objects. In the foreground, there is what appears to be a robotic arm mounted on a stand. The robot has several joints, suggesting it may have multiple degrees of freedom for movement. There's also another similar piece of equipment in the background, which could be another type of robot or machinery.

In front of the robotic arm, there is a black object that looks like a power strip or electrical box with handles on its sides, which might be used to carry it around. It seems to have multiple outlets and possibly other connections for electronic devices.

The room has a tiled floor, and in the background, you can see desks with computer monitors, indicating this could be an office or lab setting. There is also what appears to be a person sitting at one of the desks, but they are partially obscured by a desk lamp.

It's not entirely clear from the image alone whether the object inside the door has any particular significance or if it is simply part of the room's decor or equipment.
